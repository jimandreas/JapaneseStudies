<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Japanese Vocabulary Study</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans JP', sans-serif; background: #f5f5f0; color: #333; padding: 20px; max-width: 800px; margin: 0 auto; }
h1 { text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
.tabs { display: flex; gap: 4px; margin-bottom: 20px; }
.tab-btn { flex: 1; padding: 12px; border: none; background: #ddd; font-size: 1rem; font-family: inherit; cursor: pointer; border-radius: 6px 6px 0 0; transition: background 0.2s; }
.tab-btn.active { background: #4a7c59; color: #fff; }
.list { display: none; }
.list.active { display: block; }
.row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; padding: 10px 12px; border-bottom: 1px solid #e0e0d8; transition: background 0.15s; }
.row:hover { background: #eae8df; }
.jp { font-size: 2.6rem; font-weight: 700; }
.reading { font-size: 0.85rem; color: #888; }
.en { font-size: 1rem; }
.play-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; vertical-align: middle; margin-left: 6px; color: #2563eb; }
.dataset-selector { text-align: center; margin: 30px 0; }
.dataset-selector button { padding: 10px 20px; margin: 6px; border: 2px solid #4a7c59; background: #fff; color: #4a7c59; font-size: 1rem; font-family: inherit; cursor: pointer; border-radius: 6px; transition: background 0.2s, color 0.2s; }
.dataset-selector button:hover { background: #4a7c59; color: #fff; }
.flashcard-area, .quiz-area { text-align: center; }
.card { border: 2px solid #ccc; border-radius: 12px; min-height: 220px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 20px auto; max-width: 500px; cursor: pointer; padding: 30px; transition: box-shadow 0.2s; background: #fff; }
.card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
.card .jp { font-size: 3rem; }
.card .reading { font-size: 1rem; color: #888; margin-top: 6px; }
.card .en { font-size: 1.3rem; margin-top: 12px; color: #4a7c59; font-weight: 700; }
.progress { font-size: 0.95rem; color: #666; margin: 10px 0; }
.grade-btns button, .nav-btn { padding: 10px 24px; margin: 6px; border: none; border-radius: 6px; font-size: 1rem; font-family: inherit; cursor: pointer; color: #fff; }
.grade-btns .knew { background: #4a7c59; }
.grade-btns .didnt { background: #c0392b; }
.nav-btn { background: #4a7c59; }
.quiz-option { display: block; width: 100%; max-width: 500px; margin: 8px auto; padding: 14px; border: 2px solid #ccc; border-radius: 8px; font-size: 1rem; font-family: inherit; cursor: pointer; background: #fff; transition: border-color 0.2s; }
.quiz-option:hover:not(:disabled) { border-color: #4a7c59; }
.quiz-option.correct { background: #27ae60; color: #fff; border-color: #27ae60; }
.quiz-option.incorrect { background: #c0392b; color: #fff; border-color: #c0392b; }
.summary { max-width: 500px; margin: 30px auto; padding: 30px; background: #fff; border-radius: 12px; border: 2px solid #4a7c59; }
.summary h2 { margin-bottom: 12px; color: #4a7c59; }
.speed-control { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 16px; font-size: 0.9rem; color: #555; }
.speed-control input[type="range"] { width: 160px; accent-color: #4a7c59; }
@media (max-width: 600px) {
  .row { grid-template-columns: 1fr; gap: 4px; }
}
.jp-char { cursor: pointer; position: relative; }
.jp-char:hover { text-decoration: underline; text-decoration-color: #4a7c59; text-underline-offset: 4px; }
#charTooltip { position: absolute; z-index: 9999; background: #faf8f0; border: 2px solid #4a7c59; border-radius: 8px; padding: 8px 12px; font-size: 0.85rem; pointer-events: none; opacity: 0; transition: opacity 0.15s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); max-width: 240px; line-height: 1.5; }
#charTooltip.visible { opacity: 1; }
#charTooltip .tt-type { font-weight: 700; color: #4a7c59; margin-bottom: 2px; }
#charTooltip .tt-detail { color: #333; }
</style>
</head>
<body>
<h1>Japanese Vocabulary Study</h1>
<div class="speed-control">
  <label for="speed-slider">Speech Speed:</label>
  <input type="range" id="speed-slider" min="0.3" max="1.5" step="0.1" value="1.0">
  <span id="speed-value">1.0x</span>
</div>
<div class="tabs">
  <button class="tab-btn active" data-tab="menu">Restaurant Menu</button>
  <button class="tab-btn" data-tab="garden">Japanese Garden</button>
  <button class="tab-btn" data-tab="phrases">Tourist Phrases</button>
  <button class="tab-btn" data-tab="flashcard">Flashcard</button>
  <button class="tab-btn" data-tab="quiz">Quiz</button>
</div>
<div id="menu" class="list active"></div>
<div id="garden" class="list"></div>
<div id="phrases" class="list"></div>
<div id="flashcard" class="list"></div>
<div id="quiz" class="list"></div>

<script>
const speedSlider = document.getElementById("speed-slider");
const speedValue = document.getElementById("speed-value");
speedSlider.addEventListener("input", () => { speedValue.textContent = parseFloat(speedSlider.value).toFixed(1) + "x"; });

const menuData = [
  { japanese: "寿司", reading: "Sushi", english: "Sushi" },
  { japanese: "刺身", reading: "Sashimi", english: "Sashimi (Sliced raw fish)" },
  { japanese: "天ぷら", reading: "Tempura", english: "Tempura (Battered and fried)" },
  { japanese: "ラーメン", reading: "Raamen", english: "Ramen" },
  { japanese: "うどん", reading: "Udon", english: "Udon (Thick wheat noodles)" },
  { japanese: "蕎麦", reading: "Soba", english: "Soba (Buckwheat noodles)" },
  { japanese: "味噌汁", reading: "Misoshiru", english: "Miso Soup" },
  { japanese: "枝豆", reading: "Edamame", english: "Edamame (Soybeans)" },
  { japanese: "餃子", reading: "Gyouza", english: "Gyoza (Dumplings)" },
  { japanese: "焼き鳥", reading: "Yakitori", english: "Yakitori (Grilled chicken skewers)" },
  { japanese: "お好み焼き", reading: "Okonomiyaki", english: "Okonomiyaki (Savory pancake)" },
  { japanese: "たこ焼き", reading: "Takoyaki", english: "Takoyaki (Octopus balls)" },
  { japanese: "カレーライス", reading: "Kareeraisu", english: "Curry Rice" },
  { japanese: "おにぎり", reading: "Onigiri", english: "Rice Ball" },
  { japanese: "牛丼", reading: "Gyudon", english: "Beef Bowl" },
  { japanese: "親子丼", reading: "Oyakodon", english: "Chicken and Egg Bowl" },
  { japanese: "カツ丼", reading: "Katsudon", english: "Pork Cutlet Bowl" },
  { japanese: "唐揚げ", reading: "Karaage", english: "Fried Chicken" },
  { japanese: "とんかつ", reading: "Tonkatsu", english: "Pork Cutlet" },
  { japanese: "すき焼き", reading: "Sukiyaki", english: "Sukiyaki (Hot pot)" },
  { japanese: "しゃぶしゃぶ", reading: "Shabushabu", english: "Shabu-shabu (Hot pot)" },
  { japanese: "焼きそば", reading: "Yakisoba", english: "Fried Noodles" },
  { japanese: "茶碗蒸し", reading: "Chawanmushi", english: "Savory Egg Custard" },
  { japanese: "漬物", reading: "Tsukemono", english: "Pickles" },
  { japanese: "納豆", reading: "Nattou", english: "Natto (Fermented soybeans)" },
  { japanese: "鰻", reading: "Unagi", english: "Eel" },
  { japanese: "マグロ", reading: "Maguro", english: "Tuna" },
  { japanese: "サーモン", reading: "Saamon", english: "Salmon" },
  { japanese: "海老", reading: "Ebi", english: "Shrimp" },
  { japanese: "イカ", reading: "Ika", english: "Squid" },
  { japanese: "タコ", reading: "Tako", english: "Octopus" },
  { japanese: "玉子", reading: "Tamago", english: "Egg (Omelet)" },
  { japanese: "生ビール", reading: "Namabiiru", english: "Draft Beer" },
  { japanese: "日本酒", reading: "Nihonshu", english: "Sake (Rice wine)" },
  { japanese: "焼酎", reading: "Shouchuu", english: "Shochu (Distilled spirit)" },
  { japanese: "梅酒", reading: "Umeshu", english: "Plum Wine" },
  { japanese: "緑茶", reading: "Ryokucha", english: "Green Tea" },
  { japanese: "抹茶", reading: "Matcha", english: "Matcha (Powdered green tea)" },
  { japanese: "水", reading: "Mizu", english: "Water" },
  { japanese: "ご飯", reading: "Gohan", english: "Rice (Cooked)" },
  { japanese: "定食", reading: "Teishoku", english: "Set Meal" },
  { japanese: "弁当", reading: "Bentou", english: "Bento Box" },
  { japanese: "懐石料理", reading: "Kaiseki Ryouri", english: "Kaiseki (Traditional multi-course)" },
  { japanese: "居酒屋", reading: "Izakaya", english: "Izakaya (Japanese pub)" },
  { japanese: "お任せ", reading: "Omakase", english: "Omakase (Chef's choice)" },
  { japanese: "醤油", reading: "Shouyu", english: "Soy Sauce" },
  { japanese: "わさび", reading: "Wasabi", english: "Wasabi" },
  { japanese: "ガリ", reading: "Gari", english: "Pickled Ginger" },
  { japanese: "割り箸", reading: "Waribashi", english: "Disposable Chopsticks" },
  { japanese: "お会計", reading: "Okaikei", english: "Bill / Check" }
];

const gardenData = [
  { japanese: "日本庭園", reading: "Nihon Teien", english: "Japanese Garden" },
  { japanese: "灯籠", reading: "Tourou", english: "Stone Lantern" },
  { japanese: "石灯籠", reading: "Ishidourou", english: "Stone Lantern (Specific)" },
  { japanese: "枯山水", reading: "Karesansui", english: "Dry Landscape (Rock Garden)" },
  { japanese: "池", reading: "Ike", english: "Pond" },
  { japanese: "鯉", reading: "Koi", english: "Koi Fish" },
  { japanese: "橋", reading: "Hashi", english: "Bridge" },
  { japanese: "太鼓橋", reading: "Taikobashi", english: "Drum Bridge (Arched)" },
  { japanese: "手水鉢", reading: "Chouzu bachi", english: "Water Basin" },
  { japanese: "蹲踞", reading: "Tsukubai", english: "Low Water Basin (for tea ceremony)" },
  { japanese: "鹿威し", reading: "Shishiodoshi", english: "Deer Scarer (Bamboo water rocker)" },
  { japanese: "水琴窟", reading: "Suikinkutsu", english: "Buried Earthen Jar (Sound feature)" },
  { japanese: "飛び石", reading: "Tobiishi", english: "Stepping Stones" },
  { japanese: "延段", reading: "Nobedan", english: "Paved Stone Path" },
  { japanese: "石", reading: "Ishi", english: "Stone / Rock" },
  { japanese: "岩", reading: "Iwa", english: "Large Rock / Boulder" },
  { japanese: "砂", reading: "Suna", english: "Sand" },
  { japanese: "砂利", reading: "Jari", english: "Gravel" },
  { japanese: "苔", reading: "Koke", english: "Moss" },
  { japanese: "松", reading: "Matsu", english: "Pine Tree" },
  { japanese: "桜", reading: "Sakura", english: "Cherry Blossom" },
  { japanese: "紅葉", reading: "Momiji", english: "Japanese Maple" },
  { japanese: "竹", reading: "Take", english: "Bamboo" },
  { japanese: "垣根", reading: "Kakine", english: "Fence / Hedge" },
  { japanese: "竹垣", reading: "Takegaki", english: "Bamboo Fence" },
  { japanese: "借景", reading: "Shakkei", english: "Borrowed Scenery" },
  { japanese: "東屋", reading: "Azumaya", english: "Gazebo / Pavilion" },
  { japanese: "茶室", reading: "Chashitsu", english: "Tea House" },
  { japanese: "島", reading: "Shima", english: "Island" },
  { japanese: "中島", reading: "Nakajima", english: "Central Island" },
  { japanese: "滝", reading: "Taki", english: "Waterfall" },
  { japanese: "遣水", reading: "Yarimizu", english: "Stream" },
  { japanese: "築山", reading: "Tsukiyama", english: "Artificial Hill" },
  { japanese: "平庭", reading: "Hiraniwa", english: "Flat Garden" },
  { japanese: "露地", reading: "Roji", english: "Tea Garden Path" },
  { japanese: "雪見灯籠", reading: "Yukimidourou", english: "Snow-viewing Lantern" },
  { japanese: "雪吊り", reading: "Yukitsuri", english: "Rope supports for trees (Winter)" },
  { japanese: "盆栽", reading: "Bonsai", english: "Bonsai" },
  { japanese: "石組", reading: "Ishigumi", english: "Rock Arrangement" },
  { japanese: "三尊石", reading: "Sanzonseki", english: "Three-Buddha Stone Arrangement" }
];

const phrasesData = [
  { japanese: "ありがとうございます", reading: "Arigatou gozaimasu", english: "Thank you very much" },
  { japanese: "すみません", reading: "Sumimasen", english: "Excuse me / I'm sorry" },
  { japanese: "お会計お願いします", reading: "Okaikei onegai shimasu", english: "The bill, please" },
  { japanese: "生ビール大をお願いします", reading: "Nama biiru dai o onegai shimasu", english: "A large draft beer, please" },
  { japanese: "トイレはどこですか", reading: "Toire wa doko desu ka", english: "Where is the toilet?" },
  { japanese: "駅はどちらですか", reading: "Eki wa dochira desu ka", english: "Which way to the train station?" },
  { japanese: "いくらですか", reading: "Ikura desu ka", english: "How much is it?" },
  { japanese: "これをください", reading: "Kore o kudasai", english: "This one, please" },
  { japanese: "英語を話せますか", reading: "Eigo o hanasemasu ka", english: "Do you speak English?" },
  { japanese: "わかりません", reading: "Wakarimasen", english: "I don't understand" },
  { japanese: "もう一度お願いします", reading: "Mou ichido onegai shimasu", english: "One more time, please" },
  { japanese: "助けてください", reading: "Tasukete kudasai", english: "Please help me" },
  { japanese: "写真を撮ってもいいですか", reading: "Shashin o totte mo ii desu ka", english: "May I take a photo?" },
  { japanese: "おすすめは何ですか", reading: "Osusume wa nan desu ka", english: "What do you recommend?" },
  { japanese: "予約をしたいのですが", reading: "Yoyaku o shitai no desu ga", english: "I'd like to make a reservation" },
  { japanese: "Wi-Fiはありますか", reading: "Waifai wa arimasu ka", english: "Is there Wi-Fi?" },
  { japanese: "クレジットカードは使えますか", reading: "Kurejitto kaado wa tsukaemasu ka", english: "Can I use a credit card?" },
  { japanese: "メニューをお願いします", reading: "Menyuu o onegai shimasu", english: "The menu, please" },
  { japanese: "お水をお願いします", reading: "Omizu o onegai shimasu", english: "Water, please" },
  { japanese: "ここはどこですか", reading: "Koko wa doko desu ka", english: "Where am I?" },
  { japanese: "タクシーを呼んでください", reading: "Takushii o yonde kudasai", english: "Please call a taxi" },
  { japanese: "チェックインお願いします", reading: "Chekkuin onegai shimasu", english: "Check-in, please" },
  { japanese: "何時ですか", reading: "Nanji desu ka", english: "What time is it?" },
  { japanese: "アレルギーがあります", reading: "Arerugii ga arimasu", english: "I have an allergy" },
  { japanese: "美味しいです", reading: "Oishii desu", english: "It's delicious" }
];

function speak(text) {
  if (!window.speechSynthesis) { alert("Speech synthesis not supported in this browser."); return; }
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "ja-JP";
  utter.rate = parseFloat(speedSlider.value);
  const voices = window.speechSynthesis.getVoices();
  const jaVoice = voices.find(v => v.lang.startsWith("ja"));
  if (jaVoice) utter.voice = jaVoice;
  window.speechSynthesis.speak(utter);
}

function renderList(data, containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = data.map(item => `
    <div class="row">
      <div>
        <span class="jp">${wrapChars(item.japanese)}</span>
        <button class="play-btn" onclick="speak('${item.japanese}')" title="Play pronunciation">&#9654;</button>
        <div class="reading">${item.reading}</div>
      </div>
      <div class="en">${item.english}</div>
    </div>
  `).join("");
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
  return a;
}

function getDataset(name) {
  if (name === "menu") return [...menuData];
  if (name === "garden") return [...gardenData];
  if (name === "phrases") return [...phrasesData];
  return [...menuData, ...gardenData, ...phrasesData];
}

const _startCallbacks = {};
function datasetSelector(containerId, onSelect) {
  _startCallbacks[containerId] = onSelect;
  const el = document.getElementById(containerId);
  el.innerHTML = `<div class="dataset-selector"><h2>Choose a dataset</h2>
    <button onclick="_startCallbacks['${containerId}']('menu')">Menu</button>
    <button onclick="_startCallbacks['${containerId}']('garden')">Garden</button>
    <button onclick="_startCallbacks['${containerId}']('phrases')">Phrases</button>
    <button onclick="_startCallbacks['${containerId}']('both')">All</button></div>`;
}

// ---- Flashcard ----
function initFlashcard(dsName) {
  const cards = shuffle(getDataset(dsName));
  let idx = 0, known = 0, revealed = false;
  const el = document.getElementById("flashcard");

  function render() {
    if (idx >= cards.length) {
      el.innerHTML = `<div class="summary"><h2>Flashcard Complete!</h2>
        <p>You knew <strong>${known}</strong> of <strong>${cards.length}</strong> cards.</p>
        <button class="nav-btn" onclick="datasetSelector('flashcard', initFlashcard)">Restart</button></div>`;
      return;
    }
    const c = cards[idx];
    el.innerHTML = `<div class="flashcard-area">
      <div class="progress">Card ${idx + 1} of ${cards.length}</div>
      <div class="card" onclick="window._revealCard()">
        <div class="jp">${wrapChars(c.japanese)}</div>
        <button class="play-btn" onclick="event.stopPropagation();speak('${c.japanese}')" title="Play pronunciation">&#9654;</button>
        ${revealed ? `<div class="reading">${c.reading}</div><div class="en">${c.english}</div>` : `<div style="margin-top:12px;color:#999">Tap card to reveal</div>`}
      </div>
      ${revealed ? `<div class="grade-btns">
        <button class="knew" onclick="window._gradeCard(true)">I knew it</button>
        <button class="didnt" onclick="window._gradeCard(false)">I didn't know</button>
      </div>` : `<button class="nav-btn" onclick="window._revealCard()">Reveal</button>`}
    </div>`;
  }

  window._revealCard = () => { if (!revealed) { revealed = true; render(); } };
  window._gradeCard = (k) => { if (k) known++; idx++; revealed = false; render(); };
  render();
}

// ---- Quiz ----
function initQuiz(dsName) {
  const allData = getDataset(dsName);
  const questions = shuffle(allData);
  let idx = 0, score = 0, answered = false;
  const el = document.getElementById("quiz");

  function render() {
    if (idx >= questions.length) {
      el.innerHTML = `<div class="summary"><h2>Quiz Complete!</h2>
        <p>Score: <strong>${score}</strong> / <strong>${questions.length}</strong></p>
        <button class="nav-btn" onclick="datasetSelector('quiz', initQuiz)">Restart</button></div>`;
      return;
    }
    const q = questions[idx];
    const distractors = shuffle(allData.filter(d => d.english !== q.english)).slice(0, 3);
    const options = shuffle([q, ...distractors]);
    answered = false;

    el.innerHTML = `<div class="quiz-area">
      <div class="progress">Question ${idx + 1} of ${questions.length} &mdash; Score: ${score}</div>
      <div class="card" style="cursor:default">
        <div class="jp">${wrapChars(q.japanese)}</div>
        <button class="play-btn" onclick="speak('${q.japanese}')" title="Play pronunciation">&#9654;</button>
      </div>
      ${options.map((o, i) => `<button class="quiz-option" onclick="window._answer(${i},'${o.english.replace(/'/g, "\\'")}')">${o.english}</button>`).join("")}
      <div id="quiz-next" style="display:none"><button class="nav-btn" onclick="window._nextQ()">Next</button></div>
    </div>`;

    window._answer = (i, chosen) => {
      if (answered) return;
      answered = true;
      const btns = el.querySelectorAll(".quiz-option");
      btns.forEach(b => {
        b.disabled = true;
        if (b.textContent === q.english) b.classList.add("correct");
      });
      if (chosen === q.english) { score++; }
      else { btns[i].classList.add("incorrect"); }
      document.getElementById("quiz-next").style.display = "block";
    };
    window._nextQ = () => { idx++; render(); };
  }
  render();
}

// Init
renderList(menuData, "menu");
renderList(gardenData, "garden");
renderList(phrasesData, "phrases");
datasetSelector("flashcard", initFlashcard);
datasetSelector("quiz", initQuiz);

// Tabs
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".list").forEach(l => l.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// Load voices (some browsers load async)
if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = () => {};
  window.speechSynthesis.getVoices();
}

// ---- Character Tooltip System ----
const hiraganaMap = {
  "\u3042":"a","\u3044":"i","\u3046":"u","\u3048":"e","\u304A":"o",
  "\u304B":"ka","\u304D":"ki","\u304F":"ku","\u3051":"ke","\u3053":"ko",
  "\u3055":"sa","\u3057":"shi","\u3059":"su","\u305B":"se","\u305D":"so",
  "\u305F":"ta","\u3061":"chi","\u3064":"tsu","\u3066":"te","\u3068":"to",
  "\u306A":"na","\u306B":"ni","\u306C":"nu","\u306D":"ne","\u306E":"no",
  "\u306F":"ha","\u3072":"hi","\u3075":"fu","\u3078":"he","\u307B":"ho",
  "\u307E":"ma","\u307F":"mi","\u3080":"mu","\u3081":"me","\u3082":"mo",
  "\u3084":"ya","\u3086":"yu","\u3088":"yo",
  "\u3089":"ra","\u308A":"ri","\u308B":"ru","\u308C":"re","\u308D":"ro",
  "\u308F":"wa","\u3092":"wo","\u3093":"n",
  "\u304C":"ga","\u304E":"gi","\u3050":"gu","\u3052":"ge","\u3054":"go",
  "\u3056":"za","\u3058":"ji","\u305A":"zu","\u305C":"ze","\u305E":"zo",
  "\u3060":"da","\u3062":"dji","\u3065":"dzu","\u3067":"de","\u3069":"do",
  "\u3070":"ba","\u3073":"bi","\u3076":"bu","\u3079":"be","\u307C":"bo",
  "\u3071":"pa","\u3074":"pi","\u3077":"pu","\u307A":"pe","\u307D":"po",
  "\u3063":"(tsu)","\u3083":"(ya)","\u3085":"(yu)","\u3087":"(yo)","\u3041":"(a)","\u3043":"(i)","\u3045":"(u)","\u3047":"(e)","\u3049":"(o)"
};

const katakanaMap = {
  "\u30A2":"a","\u30A4":"i","\u30A6":"u","\u30A8":"e","\u30AA":"o",
  "\u30AB":"ka","\u30AD":"ki","\u30AF":"ku","\u30B1":"ke","\u30B3":"ko",
  "\u30B5":"sa","\u30B7":"shi","\u30B9":"su","\u30BB":"se","\u30BD":"so",
  "\u30BF":"ta","\u30C1":"chi","\u30C4":"tsu","\u30C6":"te","\u30C8":"to",
  "\u30CA":"na","\u30CB":"ni","\u30CC":"nu","\u30CD":"ne","\u30CE":"no",
  "\u30CF":"ha","\u30D2":"hi","\u30D5":"fu","\u30D8":"he","\u30DB":"ho",
  "\u30DE":"ma","\u30DF":"mi","\u30E0":"mu","\u30E1":"me","\u30E2":"mo",
  "\u30E4":"ya","\u30E6":"yu","\u30E8":"yo",
  "\u30E9":"ra","\u30EA":"ri","\u30EB":"ru","\u30EC":"re","\u30ED":"ro",
  "\u30EF":"wa","\u30F2":"wo","\u30F3":"n",
  "\u30AC":"ga","\u30AE":"gi","\u30B0":"gu","\u30B2":"ge","\u30B4":"go",
  "\u30B6":"za","\u30B8":"ji","\u30BA":"zu","\u30BC":"ze","\u30BE":"zo",
  "\u30C0":"da","\u30C2":"dji","\u30C5":"dzu","\u30C7":"de","\u30C9":"do",
  "\u30D0":"ba","\u30D3":"bi","\u30D6":"bu","\u30D9":"be","\u30DC":"bo",
  "\u30D1":"pa","\u30D4":"pi","\u30D7":"pu","\u30DA":"pe","\u30DD":"po",
  "\u30C3":"(tsu)","\u30E3":"(ya)","\u30E5":"(yu)","\u30E7":"(yo)","\u30A1":"(a)","\u30A3":"(i)","\u30A5":"(u)","\u30A7":"(e)","\u30A9":"(o)",
  "\u30FC":"(long vowel)"
};

// Kanji dictionary - built from all vocabulary in the app
const kanjiDict = {};
function kd(ch, meaning, reading) { kanjiDict[ch] = {meaning:meaning, reading:reading}; }
kd("\u5BFF","longevity, celebration","kotobuki / ju");
kd("\u53F8","manage, officer","tsukasa / shi");
kd("\u523A","thorn, pierce","sa / shi");
kd("\u8EAB","body","mi / shin");
kd("\u5929","heaven, sky","ama / ten");
kd("\u856A","buckwheat","soba");
kd("\u5473","taste, flavor","aji / mi");
kd("\u5653","miso","miso");
kd("\u6C41","soup, juice","shiru / juu");
kd("\u679D","branch","eda / shi");
kd("\u8C46","bean","mame / tou");
kd("\u990A","nurture","yashinau / you");
kd("\u7126","char, burn","kogeru / shou");
kd("\u713C","bake, grill","yaku / shou");
kd("\u9CE5","bird","tori / chou");
kd("\u597D","like, fond","suku / kou");
kd("\u7389","ball, jewel","tama / gyoku");
kd("\u5B50","child","ko / shi");
kd("\u725B","cow, beef","ushi / gyuu");
kd("\u4E3C","bowl","donburi / don");
kd("\u89AA","parent","oya / shin");
kd("\u5510","Tang, China","kara / tou");
kd("\u63DA","raise, fry","ageru / you");
kd("\u7D20","element, plain","moto / so");
kd("\u3076","part (kana)","bu");
kd("\u751F","life, raw","nama / sei");
kd("\u65E5","day, sun","hi / nichi");
kd("\u672C","book, origin","moto / hon");
kd("\u9152","sake, alcohol","sake / shu");
kd("\u9154","drunk","you / sui");
kd("\u5F37","strong","tsuyoi / kyou");
kd("\u68B6","rudder","kaji");
kd("\u7DD1","green","midori / ryoku");
kd("\u8336","tea","cha / sa");
kd("\u629C","pull out","nuku / batsu");
kd("\u6C34","water","mizu / sui");
kd("\u98EF","cooked rice","meshi / han");
kd("\u5B9A","fix, settle","sadameru / tei");
kd("\u98DF","eat, food","taberu / shoku");
kd("\u5F01","valve, speech","ben");
kd("\u5F53","hit, this","ataru / tou");
kd("\u61D0","bosom, nostalgia","futokoro / kai");
kd("\u77F3","stone, rock","ishi / seki");
kd("\u6599","materials, fee","ryou");
kd("\u7406","reason, logic","ri");
kd("\u5C45","reside","iru / kyo");
kd("\u4EFB","entrust","makaseru / nin");
kd("\u9170","soy sauce","shou");
kd("\u6CB9","oil","abura / yu");
kd("\u5272","divide, split","waru / katsu");
kd("\u7BB8","chopsticks","hashi");
kd("\u4F1A","meet, society","au / kai");
kd("\u8A08","measure, plan","hakaru / kei");
kd("\u5EAD","garden, yard","niwa / tei");
kd("\u5712","garden (park)","sono / en");
kd("\u706F","lamp, light","hi / tou");
kd("\u7C60","basket, cage","kago / rou");
kd("\u67AF","wither, dry","kareru / ko");
kd("\u5C71","mountain","yama / san");
kd("\u6C34","water","mizu / sui");
kd("\u6C60","pond","ike / chi");
kd("\u9BC9","carp, koi","koi / ri");
kd("\u6A4B","bridge","hashi / kyou");
kd("\u592A","thick, big","futoi / tai");
kd("\u9F13","drum","tsuzumi / ko");
kd("\u624B","hand","te / shu");
kd("\u9262","bowl, pot","hachi / hatsu");
kd("\u8E72","crouch","tsukubau / son");
kd("\u8E1E","step on","fumu / kyo");
kd("\u9E7F","deer","shika / roku");
kd("\u5A01","authority, threaten","odokasu / i");
kd("\u7434","harp, lute","koto / kin");
kd("\u7A9F","cave, grotto","iwaya / kutsu");
kd("\u98DB","fly","tobu / hi");
kd("\u5EF6","extend","nobiru / en");
kd("\u6BB5","step, tier","dan");
kd("\u5CA9","rock, cliff","iwa / gan");
kd("\u7802","sand","suna / sa");
kd("\u5229","profit, benefit","ri");
kd("\u82D4","moss","koke / tai");
kd("\u677E","pine","matsu / shou");
kd("\u685C","cherry blossom","sakura / ou");
kd("\u7D05","crimson, red","kurenai / kou");
kd("\u8449","leaf","ha / you");
kd("\u7AF9","bamboo","take / chiku");
kd("\u57A3","fence, wall","kaki / en");
kd("\u6839","root","ne / kon");
kd("\u501F","borrow","kariru / shaku");
kd("\u666F","scenery, view","kei");
kd("\u6771","east","higashi / tou");
kd("\u5C4B","roof, shop","ya / oku");
kd("\u5BA4","room","muro / shitsu");
kd("\u5CF6","island","shima / tou");
kd("\u4E2D","middle, inside","naka / chuu");
kd("\u6EDD","waterfall","taki / rou");
kd("\u9063","send, dispatch","tsukau / ken");
kd("\u7BC9","build","kizuku / chiku");
kd("\u5E73","flat, peace","taira / hei");
kd("\u9732","dew, expose","tsuyu / ro");
kd("\u5730","ground, earth","chi / ji");
kd("\u96EA","snow","yuki / setsu");
kd("\u898B","see, view","miru / ken");
kd("\u5403","hang, suspend","tsuru / chuu");
kd("\u76C6","basin, tray","bon");
kd("\u683D","planting","saibai / sai");
kd("\u7D44","group, braid","kumi / so");
kd("\u4E09","three","mi / san");
kd("\u5C0A","revere, noble","toutoi / son");
kd("\u5199","copy, photograph","utsusu / sha");
kd("\u771F","true, real","ma / shin");
kd("\u64AE","photograph","toru / satsu");
kd("\u52A9","help","tasukeru / jo");
kd("\u4E88","beforehand","yo");
kd("\u7D04","promise, approx.","yaku");
kd("\u4F7F","use","tsukau / shi");
kd("\u82F1","excellent, English","ei");
kd("\u8A9E","language, word","kataru / go");
kd("\u8A71","talk, story","hanashi / wa");
kd("\u4E00","one","hitotsu / ichi");
kd("\u5EA6","degree, time","tabi / do");
kd("\u9858","wish, request","negau / gan");
kd("\u4F55","what","nani / ka");
kd("\u6642","time, hour","toki / ji");
kd("\u7F8E","beauty","utsukushii / bi");
kd("\u99C5","station","eki");
kd("\u8C9D","shellfish","kai");
kd("\u5927","big, large","ookii / dai");
kd("\u98F2","drink","nomu / in");
kd("\u884C","go, conduct","iku / kou");
kd("\u50CF","image, statue","zou");
kd("\u6B21","next","tsugi / ji");
kd("\u5165","enter","hairu / nyuu");
kd("\u8CB7","buy","kau / bai");
kd("\u547C","call, breathe","yobu / ko");
kd("\u9298","inscription","mei");
kd("\u5B50","child","ko / shi");
kd("\u5B97","religion, sect","mune / shuu");
kd("\u304A","(hiragana o)","o");
kd("\u3059","(hiragana su)","su");
kd("\u3059","(hiragana su)","su");
kd("\u8584","thin","usui / haku");
kd("\u3059","(hiragana su)","su");
kd("\u697D","pleasure, music","tanoshii / gaku");
kd("\u9E97","beautiful","uraraka / rei");
kd("\u6587","writing, sentence","fumi / bun");
kd("\u5316","change, transform","bakeru / ka");
kd("\u5143","origin, base","moto / gen");
kd("\u5168","all, whole","subete / zen");
kd("\u90E8","section, part","bu");

function classifyChar(ch) {
  const c = ch.charCodeAt(0);
  if (c >= 0x3040 && c <= 0x309F) return "hiragana";
  if (c >= 0x30A0 && c <= 0x30FF) return "katakana";
  if (c >= 0x4E00 && c <= 0x9FFF) return "kanji";
  return "other";
}

function wrapChars(text) {
  let html = "";
  for (const ch of text) {
    const type = classifyChar(ch);
    if (type !== "other") {
      html += '<span class="jp-char">' + ch + '</span>';
    } else {
      html += ch;
    }
  }
  return html;
}

// Tooltip element
const _ttDiv = document.createElement("div");
_ttDiv.id = "charTooltip";
document.body.appendChild(_ttDiv);

function showCharTooltip(span) {
  const ch = span.textContent;
  const type = classifyChar(ch);
  if (type === "other") return;
  let label = type.charAt(0).toUpperCase() + type.slice(1);
  let detail = "";
  if (type === "hiragana" && hiraganaMap[ch]) {
    detail = ch + ' = "' + hiraganaMap[ch] + '"';
  } else if (type === "katakana" && katakanaMap[ch]) {
    detail = ch + ' = "' + katakanaMap[ch] + '"';
  } else if (type === "kanji" && kanjiDict[ch]) {
    detail = ch + ' = "' + kanjiDict[ch].reading + '"<br>' + kanjiDict[ch].meaning;
  } else if (type === "kanji") {
    detail = ch + " (not in dictionary)";
  }
  _ttDiv.innerHTML = '<div class="tt-type">' + label + '</div><div class="tt-detail">' + detail + '</div>';
  const rect = span.getBoundingClientRect();
  _ttDiv.style.left = (window.scrollX + rect.left) + "px";
  _ttDiv.style.top = (window.scrollY + rect.bottom + 6) + "px";
  _ttDiv.classList.add("visible");
}

function hideCharTooltip() { _ttDiv.classList.remove("visible"); }

document.addEventListener("mouseover", function(e) {
  if (e.target.classList && e.target.classList.contains("jp-char")) showCharTooltip(e.target);
});
document.addEventListener("mouseout", function(e) {
  if (e.target.classList && e.target.classList.contains("jp-char")) hideCharTooltip();
});
document.addEventListener("click", function(e) {
  if (e.target.classList && e.target.classList.contains("jp-char")) {
    if (_ttDiv.classList.contains("visible")) hideCharTooltip();
    else showCharTooltip(e.target);
  } else { hideCharTooltip(); }
});
</script>
</body>
</html>
